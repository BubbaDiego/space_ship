{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
  /* -------------------- Background Wallpaper -------------------- */
  body {
    background: url("{{ url_for('static', filename='images/wallpaper.png') }}") no-repeat center center fixed;
    background-size: cover;
  }

  /* -------------------- General Card Header Styling -------------------- */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #e7f0fd;
    padding: 0.5rem 1rem;
    height: 50px;
  }
  .header-icon {
    font-size: 1.5rem !important;
  }
  .header-icon.left i { color: green !important; }
  .header-icon.center { flex-grow: 1; text-align: center; }
  .header-icon.center span,
  .header-icon.right span { font-size: 1.5rem; color: #000; }

  /* -------------------- Liquidation Bar Styles -------------------- */
  .progress.liquidation {
    position: relative;
    background-color: #e9ecef;
    height: 1.5rem;
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .progress.liquidation::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 3px;
    background-color: rgba(0,0,0,0.7);
    z-index: 5;
  }
  .liquidation-fill {
    position: absolute;
    height: 100%;
    border-radius: 1rem;
  }
  .liquidation-fill.striped {
    background-image: linear-gradient(
      45deg,
      rgba(255,255,255,0.15) 25%,
      transparent 25%,
      transparent 50%,
      rgba(255,255,255,0.15) 50%,
      rgba(255,255,255,0.15) 75%,
      transparent 75%,
      transparent
    );
    background-size: 1rem 1rem;
  }
  .asset-icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 1px solid #ccc;
    z-index: 10;
  }
  .progress-text {
    position: absolute;
    font-weight: bold;
    color: white;
    z-index: 20;
  }

  /* -------------------- Dashboard Layout -------------------- */
  .card-container {
    margin: 2.5px auto;
  }
  .row {
    margin-bottom: 20px;
  }
  .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
  }
  @media (max-width: 767.98px) {
    .col-md-6 {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }

  /* -------------------- Top Bar & Status Bar Layout -------------------- */
  .top-row {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  .update-col, .status-col {
    flex: 0 0 100%;
  }
  @media (min-width: 768px) {
    .update-col, .status-col {
      flex: 0 0 50%;
      max-width: 50%;
    }
  }
  .top-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0;
  }
  .top-bar .update-btn img {
    width: 70px;
    height: 70px;
    cursor: pointer;
    border-radius: 50%;
  }
  .status-bar {
    width: 100%;
  }
  .toggle-group {
    margin-left: auto;
  }
  .status-bar .card-body {
    padding: 0.15rem 0.4rem !important;
    text-align: center;
    min-height: 25px !important;
    padding-top: 0.05rem !important;
  }
  .status-bar .card-body .row > .col {
    align-items: flex-start !important;
  }
  .status-bar .card-body h5 {
    font-size: 1rem !important;
    margin: 0;
  }
  .status-bar .card-body span {
    font-size: 0.85rem !important;
  }
  .status-bar .card-body i {
    font-size: 14px !important;
    margin-right: 2px;
  }
  .status-bar .card-body img {
    margin-right: 4px;
    height: 24px !important;
    margin-top: 4px;
  }
  .portfolio-label {
    color: #00008B;
    font-weight: bold;
  }

  /* -------------------- Composition Chart (Size + Collateral) -------------------- */
  .composition-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #e7f0fd;
    padding: 0.5rem 1rem;
  }
  .composition-header h3 {
    margin: 0;
    width: 50%;
    text-align: center;
    font-size: 1.2rem;
  }
  .composition-container {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
  }
  .composition-container > div {
    width: 48%;
    height: 233px;
  }

  /* -------------------- Performance Card Time Controls -------------------- */
  .performance-time-controls .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.65rem;
    opacity: 0.7;
    margin-bottom: 0.2rem;
  }
  .performance-time-controls .btn:hover {
    opacity: 1;
  }

  /*
    ========================
    START: SIZE BALANCE SECTION (CSS)
    ========================
    - We add extra bottom padding to the chart for image space.
    - Then we position the images row (asset-labels) with a negative top margin.
    - We now offset each column individually as follows:
        Column 1: +50px (unchanged)
        Columns 2,3,4,5: shifted an extra 1 space (25px) to the right from their previous values.
        Column 6 remains the same.
  */

  /*
    Move the entire images row up an extra 12px (half a space)
    New margin-top: -132px (was -120px)
  */
  .asset-labels {
    display: flex;
    justify-content: space-around;
    margin-top: -142px;
    margin-bottom: 20px;
  }

  /*
    Each column container (.size-chart-col) holds the wallet image on top and the asset image below.
    New offsets:
      - Column 1: margin-left: 50px (unchanged)
      - Column 2: margin-left: 50px (was 25px + 25px)
      - Column 3: margin-left: 37px (was 12px + 25px)
      - Column 4: margin-left: 25px (was 0 + 25px)
      - Column 5: margin-left: 25px (was 0 + 25px)
      - Column 6: margin-left: -12px (unchanged)
  */
  .size-chart-col {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .size-chart-col:nth-child(1) {
    margin-left: 60px;
  }
  .size-chart-col:nth-child(2) {
    margin-left: 55x;
  }
  .size-chart-col:nth-child(3) {
    margin-left: 5px;
  }
  .size-chart-col:nth-child(4) {
    margin-left: 5px;
  }
  .size-chart-col:nth-child(5) {
    margin-left: 4px;
  }
  .size-chart-col:nth-child(6) {
    margin-left: 2px;
  }

  /*
    Set images sizes at 50% reduction:
    - wallet-icon: 25x25
    - asset-icon2: 20x20
  */
  .wallet-icon {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 1px solid #ccc;
    margin-bottom: 5px;
  }
  .asset-icon2 {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid #ccc;
  }

  .size-chart-col p {
    margin: 2px 0;
    font-size: 10px;
  }

  /*
    ======================
    END: SIZE BALANCE SECTION (CSS)
    ======================
  */
</style>
{% endblock %}

{% block content %}
<div class="container card-container">
  <!-- Row for the Update Button & Status Bar -->
  <div class="row top-row">
    <div class="col-md-6 update-col">
      <div class="top-bar">
        <!-- Jupiter Update Button -->
        <div class="update-btn">
          <button type="button" class="update-button" data-type="jupiter" style="background: none; border: none; padding: 0;">
            <img id="update-button-img-jupiter" src="{{ url_for('static', filename='images/jupiter.jpg') }}" alt="Jupiter Update Button">
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-6 status-col">
      <div class="top-bar">
        <!-- Subtle Radio Toggle -->
        <div class="toggle-group d-flex">
          <div class="btn-group btn-group-sm" role="group" aria-label="Toggle Hours">
            <input type="radio" class="btn-check" name="hours" id="hours1" value="1" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="hours1">1h</label>
            <input type="radio" class="btn-check" name="hours" id="hours6" value="6" autocomplete="off">
            <label class="btn btn-outline-secondary" for="hours6">6h</label>
            <input type="radio" class="btn-check" name="hours" id="hours12" value="12" autocomplete="off">
            <label class="btn btn-outline-secondary" for="hours12">12h</label>
            <input type="radio" class="btn-check" name="hours" id="hours14" value="14" autocomplete="off">
            <label class="btn btn-outline-secondary" for="hours14">14h</label>
          </div>
        </div>
      </div>
      <!-- Status Bar with cityscape wallpaper -->
      <div class="status-bar mt-2"
           style="background: url('{{ url_for('static', filename='images/cityscape.jpg') }}') no-repeat center center; background-size: cover;">
        <!-- Transparent card so text is legible -->
        <div class="card" style="background-color: rgba(255, 255, 255, 0.5);">
          <div class="card-body">
            <div class="row">
              <!-- Portfolio: label is dark blue, price is normal color -->
              <div class="col d-flex align-items-center justify-content-center border-end">
                <img src="{{ url_for('static', filename='images/wallet.png') }}" alt="Wallet Icon">
                <div>
                  <span class="text-success"><i class="bi bi-caret-up-fill"></i> {{ portfolio_change }}%</span>
                  <h5 class="fw-bold mb-0">${{ portfolio_value }}</h5>
                  <span class="portfolio-label">PORTFOLIO</span>
                </div>
              </div>
              <!-- Bitcoin: No label, bigger icon, moved down -->
              <div class="col d-flex align-items-center justify-content-center border-end">
                <img src="{{ url_for('static', filename='images/btc_logo.png') }}" alt="BTC">
                <div>
                  <span class="text-success"><i class="bi bi-caret-up-fill"></i> {{ btc_change }}%</span>
                  <h5 class="fw-bold mb-0">${{ btc_price }}</h5>
                </div>
              </div>
              <!-- Ethereum: No label, bigger icon, moved down -->
              <div class="col d-flex align-items-center justify-content-center border-end">
                <img src="{{ url_for('static', filename='images/eth_logo.png') }}" alt="ETH">
                <div>
                  <span class="text-info"><i class="bi bi-caret-left-fill"></i> {{ eth_change }}%</span>
                  <h5 class="fw-bold mb-0">${{ eth_price }}</h5>
                </div>
              </div>
              <!-- Solana: No label, bigger icon, moved down -->
              <div class="col d-flex align-items-center justify-content-center border-end">
                <img src="{{ url_for('static', filename='images/sol_logo.png') }}" alt="SOL">
                <div>
                  <span class="text-success"><i class="bi bi-caret-up-fill"></i> {{ sol_change }}%</span>
                  <h5 class="fw-bold mb-0">${{ sol_price }}</h5>
                </div>
              </div>
              <!-- S&P 500: Keep label -->
              <div class="col d-flex align-items-center justify-content-center">
                <div>
                  <span class="text-danger"><i class="bi bi-caret-down-fill"></i> {{ sp500_change }}%</span>
                  <h5 class="fw-bold mb-0">{{ sp500_value }}</h5>
                  <span class="text-uppercase">S&P 500</span>
                </div>
              </div>
            </div> <!-- end row -->
          </div> <!-- end card-body -->
        </div> <!-- end card -->
      </div> <!-- end status-bar -->
    </div>
  </div> <!-- end row -->

  <!-- Row: Liquidation Bar & Portfolio Performance -->
  <div class="row">
    <!-- Liquidation Bar Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="header-icon left"><i class="bi bi-currency-dollar"></i></div>
          <div class="header-icon center"><span>⚖</span></div>
          <div class="header-icon right"><span>💀</span></div>
        </div>
        <div class="card-body">
          {% for pos in liquidation_positions %}
            {% set travel = pos.current_travel_percent | float %}
            <div class="progress liquidation">
              {% if travel >= 0 %}
                <div class="liquidation-fill striped bg-success" style="right: 50%; width: calc(({{ travel }} / 100) * 50%);"></div>
                <img class="asset-icon" src="{{ url_for('static', filename='images/' ~ (pos.asset_type|default('btc')|lower) ~ '_logo.png') }}"
                     alt="{{ pos.asset_type|default('btc')|lower }} logo"
                     style="left: calc(50% - ({{ travel }} / 100 * 50%) - 15px); {% if (pos.asset_type|default('btc')|lower)=='eth' %}background-color: white;{% endif %}">
                {% if travel > 25 %}
                  <span class="progress-text" style="left: calc(50% - ({{ travel }} / 100 * 25%)); top: 50%; transform: translate(-50%, -50%);">
                    {{ travel }}%
                  </span>
                {% endif %}
              {% else %}
                <div class="liquidation-fill striped bg-danger" style="left: 50%; width: calc(({{ travel | abs }} / 100) * 50%);"></div>
                <img class="asset-icon" src="{{ url_for('static', filename='images/' ~ (pos.asset_type|default('btc')|lower) ~ '_logo.png') }}"
                     alt="{{ pos.asset_type|default('btc')|lower }} logo"
                     style="left: calc(50% + ({{ travel | abs }} / 100 * 50%) - 15px); {% if (pos.asset_type|default('btc')|lower)=='eth' %}background-color: white;{% endif %}">
                {% if travel < -25 %}
                  <span class="progress-text" style="left: calc(50% + ({{ travel | abs }} / 100 * 25%)); top: 50%; transform: translate(-50%, -50%);">
                    {{ travel }}%
                  </span>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Portfolio Performance Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex align-items-center">
          <h3 class="card-title mb-0">Performance</h3>
          <small id="percentChangeDisplay" class="ms-auto" style="font-weight: bold; font-size: 1.5rem;"></small>
        </div>
        <div class="card-body" style="position: relative;">
          <div class="d-flex">
            <div class="flex-grow-1">
              <canvas id="portfolioChart" style="width: 100%; height: 300px;"></canvas>
            </div>
            <div class="performance-time-controls d-flex flex-column justify-content-center" style="margin-left: 10px;">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPortfolioTimeframe(1)">1h</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPortfolioTimeframe(3)">3h</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPortfolioTimeframe(6)">6h</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPortfolioTimeframe(12)">12h</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPortfolioTimeframe(24)">24h</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row: Size Balance Bar Chart & Composition Card -->
  <div class="row">
    <!--
      ============================
      START: SIZE BALANCE SECTION (HTML)
      ============================
    -->
    <div class="col-md-6">
      <div class="card shadow">
        <!-- Card header with title and legend -->
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">Size Balance</h3>
          <div class="legend">
            <span class="me-3">
              <i class="bi bi-square-fill" style="color:#0d6efd;"></i> Long
            </span>
            <span class="me-3">
              <i class="bi bi-square-fill" style="color:#20c997;"></i> Short
            </span>
            <span>
              <i class="bi bi-square-fill" style="color:#ffc107;"></i> Total
            </span>
          </div>
        </div>
        <div class="card-body">
          <!-- Chart container -->
          <div id="size-chart"></div>

          <!-- 6 columns to match 6 bar groups -->
          <div class="asset-labels">
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/obivault.jpg') }}" alt="ObiVault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/btc_logo.png') }}" alt="BTC">
            </div>
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/obivault.jpg') }}" alt="ObiVault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/eth_logo.png') }}" alt="ETH">
            </div>
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/obivault.jpg') }}" alt="ObiVault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/sol_logo.png') }}" alt="SOL">
            </div>
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/r2vault.jpg') }}" alt="R2Vault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/btc_logo.png') }}" alt="BTC">
            </div>
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/r2vault.jpg') }}" alt="R2Vault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/eth_logo.png') }}" alt="ETH">
            </div>
            <div class="size-chart-col">
              <img class="wallet-icon" src="{{ url_for('static', filename='images/r2vault.jpg') }}" alt="R2Vault">
              <img class="asset-icon2" src="{{ url_for('static', filename='images/sol_logo.png') }}" alt="SOL">
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--
      ==========================
      END: SIZE BALANCE SECTION (HTML)
      ==========================
    -->

    <!-- Composition Card (unchanged) -->
    <div class="col-md-6">
      <div class="card">
        <div class="composition-header">
          <h3>📐 Size</h3>
          <h3>Collateral 💸</h3>
        </div>
        <div class="card-body">
          <div class="composition-container">
            <!-- Left chart: Size Composition -->
            <div id="positions-chart"></div>
            <!-- Right chart: Collateral Composition -->
            <div id="collateral-composition-chart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Include Chart.js and adapter for time scales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  const portfolioData = {{ portfolio_data | tojson }};
  let portfolioChart;

  document.addEventListener('DOMContentLoaded', function() {
    if (!portfolioData || portfolioData.length === 0) {
      console.warn("No portfolio data available for chart rendering.");
      return;
    }
    const labels = portfolioData.map(item => item.snapshot_time);
    const valueData = portfolioData.map(item => item.total_value);
    const collateralData = portfolioData.map(item => item.total_collateral);

    const ctx = document.getElementById('portfolioChart').getContext('2d');
    portfolioChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Total Portfolio Value',
            data: valueData,
            borderColor: 'rgba(75, 192, 192, 1)',
            fill: false
          },
          {
            label: 'Total Collateral',
            data: collateralData,
            borderColor: 'rgba(192, 75, 192, 1)',
            fill: false
          }
        ]
      },
      options: {
        scales: {
          x: { type: 'time', time: { unit: 'day' } },
          y: { beginAtZero: true }
        }
      }
    });
    setPortfolioTimeframe(24);
  });

  function setPortfolioTimeframe(hours) {
    if (!portfolioData || portfolioData.length === 0) return;
    const currentTime = new Date();
    const cutoff = new Date(currentTime.getTime() - hours * 3600000);
    const filteredData = portfolioData.filter(item => new Date(item.snapshot_time) >= cutoff);
    portfolioChart.data.labels = filteredData.map(item => item.snapshot_time);
    portfolioChart.data.datasets[0].data = filteredData.map(item => item.total_value);
    portfolioChart.data.datasets[1].data = filteredData.map(item => item.total_collateral);
    portfolioChart.update();
    if (filteredData.length > 0) {
      const firstValue = filteredData[0].total_value;
      const lastValue = filteredData[filteredData.length - 1].total_value;
      const percentChange = ((lastValue - firstValue) / firstValue) * 100;
      const percentElem = document.getElementById("percentChangeDisplay");
      if (percentElem) {
        percentElem.textContent = percentChange.toFixed(2) + "%";
        percentElem.style.color = percentChange >= 0 ? "green" : "red";
      }
    }
  }
</script>

<!-- ApexCharts for the Size/Collateral Composition & Size Balance charts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" crossorigin="anonymous"></script>
<script>
  // SIZE Composition Chart (Pie) - for the Composition Card
  window.onload = function() {
    if (typeof ApexCharts === 'undefined') {
      console.error("ApexCharts library not loaded!");
      return;
    }
    // SIZE Composition (left pie chart)
    const positionsChartContainer = document.getElementById("positions-chart");
    if (positionsChartContainer) {
      fetch("/api/size_composition")
        .then(response => response.json())
        .then(data => {
          const seriesData = data.series || [0, 0];
          const options = {
            series: seriesData,
            chart: {
              type: 'pie',
              height: 233,
              events: {
                click: function(event, chartContext, config) {
                  const currentType = positionsChartInstance.w.config.chart.type;
                  const newType = (currentType === 'pie') ? 'donut' : 'pie';
                  positionsChartInstance.updateOptions({ chart: { type: newType } });
                }
              }
            },
            labels: ['Long Positions', 'Short Positions'],
            colors: ['#0d6efd', '#5dcc8e'],
            legend: { position: 'bottom' },
            dataLabels: {
              enabled: true,
              style: { fontSize: '1rem' },
              formatter: function (val) {
                return val.toFixed(2) + "%";
              }
            },
            plotOptions: {
              pie: {
                dataLabels: { offset: -5 }
              }
            }
          };
          const positionsChartInstance = new ApexCharts(positionsChartContainer, options);
          positionsChartInstance.render().catch(err => {
            console.error("ApexCharts (Size) render error:", err);
          });
        })
        .catch(err => {
          console.error("Error fetching size composition data:", err);
        });
    }

    // COLLATERAL Composition Chart (Pie) - for the Composition Card
    const collateralChartContainer = document.getElementById("collateral-composition-chart");
    if (collateralChartContainer) {
      fetch("/api/collateral_composition")
        .then(response => response.json())
        .then(data => {
          const seriesData = data.series || [0, 0];
          const collateralOptions = {
            series: seriesData,
            chart: {
              type: 'pie',
              height: 233,
              events: {
                click: function(event, chartContext, config) {
                  const currentType = collateralChartInstance.w.config.chart.type;
                  const newType = (currentType === 'pie') ? 'donut' : 'pie';
                  collateralChartInstance.updateOptions({ chart: { type: newType } });
                }
              }
            },
            labels: ['Long Collateral', 'Short Collateral'],
            colors: ['#28a745', '#ffc107'],
            legend: { position: 'bottom' },
            dataLabels: {
              enabled: true,
              style: { fontSize: '1rem' },
              formatter: function (val) {
                return val.toFixed(2) + "%";
              }
            },
            plotOptions: {
              pie: {
                dataLabels: { offset: -5 }
              }
            }
          };
          const collateralChartInstance = new ApexCharts(collateralChartContainer, collateralOptions);
          collateralChartInstance.render().catch(err => {
            console.error("ApexCharts (Collateral) render error:", err);
          });
        })
        .catch(err => {
          console.error("Error fetching collateral composition data:", err);
        });
    }
  };

  /*
    ============================
    START: SIZE BALANCE SECTION (JS)
    ============================
    This bar chart displays the Size Balance data from /api/size_balance,
    with extra bottom padding for the image row.
  */
  document.addEventListener('DOMContentLoaded', function() {
    const sizeChartContainer = document.getElementById("size-chart");
    if (sizeChartContainer) {
      fetch("/api/size_balance")
        .then(response => response.json())
        .then(data => {
          const chartOptions = {
            series: [
              { name: 'Long',  data: data.long  },
              { name: 'Short', data: data.short },
              { name: 'Total', data: data.total }
            ],
            chart: {
              type: 'bar',
              height: 400,
              toolbar: { show: false }
            },
            grid: { padding: { bottom: 120 } },
            plotOptions: {
              bar: {
                horizontal: false,
                columnWidth: '55%',
                endingShape: 'rounded'
              }
            },
            dataLabels: { enabled: false },
            stroke: { show: true, width: 2, colors: ['transparent'] },
            colors: ['#0d6efd', '#20c997', '#ffc107'],
            xaxis: {
              categories: ['', '', '', '', '', ''],
              labels: { show: false }
            },
            yaxis: {
              title: { text: 'Size Amount' },
              labels: {
                formatter: function(val) {
                  return Math.round(val / 1000) + "k";
                }
              }
            },
            fill: { opacity: 1 },
            tooltip: {
              y: { formatter: (val) => val }
            },
            legend: { show: false },
            annotations: {
              yaxis: [
                {
                  y: data.avg_short || 2683.33,
                  borderColor: '#20c997',
                  label: {
                    borderColor: '#20c997',
                    style: { color: '#fff', background: '#20c997' },
                    text: 'Avg Short'
                  },
                  strokeDashArray: 4
                },
                {
                  y: data.avg_long || 4500,
                  borderColor: '#0d6efd',
                  label: {
                    borderColor: '#0d6efd',
                    style: { color: '#fff', background: '#0d6efd' },
                    text: 'Avg Long'
                  },
                  strokeDashArray: 4
                }
              ]
            }
          };
          const sizeChart = new ApexCharts(sizeChartContainer, chartOptions);
          sizeChart.render();
        })
        .catch(err => console.error("Error fetching size balance data:", err));
    }
  });
  /*
    ==========================
    END: SIZE BALANCE SECTION (JS)
    ==========================
  */
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.querySelector('.update-button[data-type="{{ update_type | default("jupiter") }}"]');
    if (!container) return;
    const img = container.querySelector('img');
    container.addEventListener("click", function() {
      img.classList.add("spin");
      fetch("/positions/update_jupiter?source={{ update_type | default('jupiter') }}", { method: "POST" })
        .then(response => response.json())
        .then(data => {
          img.classList.remove("spin");
          window.location.reload();
        })
        .catch(err => {
          img.classList.remove("spin");
          console.error(err);
        });
    });
  });
</script>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .spin { animation: spin 1s linear infinite; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.add(currentTheme + '-mode');
    const themeToggle = document.getElementById('themeToggle');
    if (!themeToggle) return;
    themeToggle.checked = (currentTheme === 'dark');
    themeToggle.addEventListener('change', function() {
      if (this.checked) {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        localStorage.setItem('theme', 'light');
      }
    });
  });
</script>
{% endblock %}

{% extends "base.html" %}

{% block head_extra %}
  <!-- Include ApexCharts library (for other charts) -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block page_title %}
<div class="d-flex align-items-center">
  <!-- Jupiter Update Button with extra margin -->
  <div class="update-button me-2" data-type="{{ update_type | default('jupiter') }}">
    {% if update_type == 'crypto' %}
      <img id="update-button-img-{{ update_type }}"
           src="{{ url_for('static', filename='images/crypto_icon.jpg') }}"
           alt="Crypto Update Button"
           style="width: 70px; height: 70px; cursor: pointer;">
    {% elif update_type == 'jupiter' %}
      <img id="update-button-img-{{ update_type }}"
           src="{{ url_for('static', filename='images/jupiter.jpg') }}"
           alt="Jupiter Update Button"
           style="width: 70px; height: 70px; cursor: pointer;">
    {% else %}
      <img id="update-button-img-{{ update_type }}"
           src="{{ url_for('static', filename='images/crypto_icon.jpg') }}"
           alt="All Update Button"
           style="width: 70px; height: 70px; cursor: pointer;">
    {% endif %}
  </div>
  <span class="ms-3">Dashboard</span>
</div>
{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <!-- Row: Left column = Liquidation Bar, Right column = Portfolio Chart Card -->
    <div class="row">
      <div class="col-md-6">
        {% include "liquidation_bar.html" %}
      </div>
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
              Portfolio Performance
              {% if timeframe %}
                <small class="text-muted">(Last {{ timeframe }} Hours)</small>
              {% endif %}
            </h3>
            <!-- Subtle Time Range Selector -->
            <div id="portfolioTimeframeControls">
              <div class="btn-group btn-group-sm" role="group" aria-label="Portfolio Timeframe">
                <button type="button" class="btn btn-outline-secondary {% if timeframe == 1 %}active{% endif %}" onclick="setPortfolioTimeframe(1)">1h</button>
                <button type="button" class="btn btn-outline-secondary {% if timeframe == 3 %}active{% endif %}" onclick="setPortfolioTimeframe(3)">3h</button>
                <button type="button" class="btn btn-outline-secondary {% if timeframe == 6 %}active{% endif %}" onclick="setPortfolioTimeframe(6)">6h</button>
                <button type="button" class="btn btn-outline-secondary {% if timeframe == 12 %}active{% endif %}" onclick="setPortfolioTimeframe(12)">12h</button>
                <button type="button" class="btn btn-outline-secondary {% if timeframe == 24 %}active{% endif %}" onclick="setPortfolioTimeframe(24)">24h</button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="portfolioChart" style="width: 100%; height: 300px;"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!-- Top Positions Section -->
    <div class="row">
      <div class="col-12">
        {% include "top_positions.html" %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const container = document.querySelector('.update-button[data-type="{{ update_type | default("jupiter") }}"]');
  if (!container) return;
  const img = container.querySelector('img');

  // Define the image URLs
  const cryptoURL = "{{ url_for('static', filename='images/crypto_icon.jpg') }}";
  const jupiterURL = "{{ url_for('static', filename='images/jupiter.jpg') }}";

  container.addEventListener("click", function() {
    console.log("Update button (type {{ update_type | default('jupiter') }}) clicked.");
    img.classList.add("spin");

    fetch("/positions/update_jupiter?source={{ update_type | default('jupiter') }}", { method: "POST" })
      .then(response => response.json())
      .then(data => {
          console.log("Update response:", data);
          img.classList.remove("spin");
          if ("{{ update_type | default('jupiter') }}" === "all") {
              if (img.getAttribute("src") === cryptoURL) {
                  img.setAttribute("src", jupiterURL);
              } else {
                  img.setAttribute("src", cryptoURL);
              }
          }
      })
      .catch(err => {
          console.error("Error updating positions:", err);
          img.classList.remove("spin");
      });
  });
});
</script>
<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
.spin {
  animation: spin 1s linear infinite;
}
</style>

<!-- Include Chart.js and adapter for time scales for the portfolio chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Assume portfolio_data is provided by the dashboard route similar to portfolio.html
  const portfolioData = {{ portfolio_data | default([]) | tojson }};
  if (!portfolioData || portfolioData.length === 0) {
    console.warn("No portfolio data available for chart rendering.");
    return;
  }
  const labels = portfolioData.map(item => item.snapshot_time);
  const data = portfolioData.map(item => item.total_value);
  const ctx = document.getElementById('portfolioChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total Portfolio Value',
        data: data,
        borderColor: 'rgba(75, 192, 192, 1)',
        fill: false
      }]
    },
    options: {
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day' }
        },
        y: { beginAtZero: true }
      }
    }
  });
});

// Function to update the timeframe by modifying the URL query parameter.
function setPortfolioTimeframe(hours) {
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.set('hours', hours);
  // Reload the page with the new timeframe
  window.location.search = urlParams.toString();
}
</script>
{% endblock %}

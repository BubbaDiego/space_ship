{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
  /* -------------------- Background Wallpaper -------------------- */
  body {
    background: url("{{ url_for('static', filename='images/wallpaper.png') }}") no-repeat center center fixed;
    background-size: cover;
  }

  /* -------------------- General Card Header Styling -------------------- */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #e7f0fd; /* subtle blue */
    padding: 0.5rem 1rem;
  }
  .header-icon {
    font-size: 1.5rem !important;
  }
  .header-icon.left i { color: green !important; }
  .header-icon.center { flex-grow: 1; text-align: center; }
  .header-icon.center span,
  .header-icon.right span { font-size: 1.5rem; color: #000; }

  /* -------------------- Liquidation Bar Styles -------------------- */
  .progress.liquidation {
    position: relative;
    background-color: #e9ecef;
    height: 1.5rem;
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .progress.liquidation::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 3px;
    background-color: rgba(0,0,0,0.7);
    z-index: 5;
  }
  .liquidation-fill {
    position: absolute;
    height: 100%;
    border-radius: 1rem;
  }
  .liquidation-fill.striped {
    background-image: linear-gradient(
      45deg,
      rgba(255,255,255,0.15) 25%,
      transparent 25%,
      transparent 50%,
      rgba(255,255,255,0.15) 50%,
      rgba(255,255,255,0.15) 75%,
      transparent 75%,
      transparent
    );
    background-size: 1rem 1rem;
  }
  .asset-icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 1px solid #ccc;
    z-index: 10;
  }
  .progress-text {
    position: absolute;
    font-weight: bold;
    color: white;
    z-index: 20;
  }

  /* -------------------- Dashboard Layout -------------------- */
  .card-container {
    margin: 20px auto;
  }
  .row {
    margin-bottom: 20px;
  }
  /* Two columns on medium+ screens, one column on small screens */
  .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
  }
  @media (max-width: 767.98px) {
    .col-md-6 {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }

  /* -------------------- Top Positions (Thinner Rows) -------------------- */
  .info-box {
    display: flex;
    align-items: center;
    background-color: #e0e0e0;
    padding: 1px !important;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1px !important;
    width: 100% !important;
  }
  .info-box-wallet {
    margin-left: auto;
    display: flex;
    align-items: center;
  }
  .info-box-wallet img {
    border-radius: 50%;
    width: 30px;
    height: 30px;
  }
  .info-box-asset {
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .info-box-extra {
    display: inline-flex;
    align-items: center;
    font-size: 0.6rem;
    margin: 0;
  }
  .info-box-extra img {
    vertical-align: middle;
    width: 20px;
    height: 20px;
  }
  .info-box-extra span { margin-left: 2px; }
  .info-box-extra span:last-child {
    font-size: 0.65rem;
    font-weight: bold;
  }
  .info-box-icon {
    width: 30px;
    height: 25px;
    line-height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    margin-right: 2px;
  }
  .text-bg-blue { background-color: #007bff !important; }
  .text-bg-success { background-color: #28a745 !important; }
  .text-bg-warning { background-color: #ffc107 !important; }
  .text-bg-danger { background-color: #dc3545 !important; }
  .small-percentage {
    font-size: 0.75rem !important;
    font-weight: bold !important;
    font-family: 'Nunito', sans-serif;
    color: white !important;
    margin-right: 0 !important;
  }
  .info-box-details {
    display: flex;
    gap: 3px;
    font-size: 0.75rem;
    align-items: center;
    margin-left: 2px;
  }

  /* -------------------- Size Comparison Chart -------------------- */
  #positions-chart {
    /* Chart container for ApexCharts */
  }
</style>
{% endblock %}

{% block content %}
<!-- Jupiter Update Button in the Upper Left Corner -->
<div style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
  <button type="button" class="update-button" data-type="jupiter" style="background: none; border: none; padding: 0;">
    <img id="update-button-img-jupiter"
         src="{{ url_for('static', filename='images/jupiter.jpg') }}"
         alt="Jupiter Update Button"
         style="width: 70px; height: 70px; cursor: pointer; border-radius: 50%; display: block;">
  </button>
</div>

<!-- Main Dashboard Content (pushed down to avoid overlap) -->
<div class="container card-container" style="padding-top: 90px;">
  <!-- Row 1: Liquidation Bar Card and Portfolio Performance Card -->
  <div class="row">
    <!-- Liquidation Bar Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <div class="header-icon left">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <div class="header-icon center">
            <span>âš–</span>
          </div>
          <div class="header-icon right">
            <span>ðŸ’€</span>
          </div>
        </div>
        <div class="card-body">
          {% for pos in liquidation_positions %}
            {% set travel = pos.current_travel_percent | float %}
            <div class="progress liquidation">
              {% if travel >= 0 %}
                <div class="liquidation-fill striped bg-success"
                     style="right: 50%; width: calc(({{ travel }} / 100) * 50%);"></div>
                <img class="asset-icon"
                     src="{{ url_for('static', filename='images/' ~ (pos.asset_type|default('btc')|lower) ~ '_logo.png') }}"
                     alt="{{ pos.asset_type|default('btc')|lower }} logo"
                     style="left: calc(50% - ({{ travel }} / 100 * 50%) - 15px); {% if (pos.asset_type|default('btc')|lower)=='eth' %}background-color: white;{% endif %}">
                {% if travel > 25 %}
                  <span class="progress-text" style="left: calc(50% - ({{ travel }} / 100 * 25%)); top: 50%; transform: translate(-50%, -50%);">
                    {{ travel }}%
                  </span>
                {% endif %}
              {% else %}
                <div class="liquidation-fill striped bg-danger"
                     style="left: 50%; width: calc(({{ travel | abs }} / 100) * 50%);"></div>
                <img class="asset-icon"
                     src="{{ url_for('static', filename='images/' ~ (pos.asset_type|default('btc')|lower) ~ '_logo.png') }}"
                     alt="{{ pos.asset_type|default('btc')|lower }} logo"
                     style="left: calc(50% + ({{ travel | abs }} / 100 * 50%) - 15px); {% if (pos.asset_type|default('btc')|lower)=='eth' %}background-color: white;{% endif %}">
                {% if travel < -25 %}
                  <span class="progress-text" style="left: calc(50% + ({{ travel | abs }} / 100 * 25%)); top: 50%; transform: translate(-50%, -50%);">
                    {{ travel }}%
                  </span>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Portfolio Performance Card (Updated Title) -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center" style="position: relative;">
          <div>
            <h3 class="card-title mb-0">Performance</h3>
          </div>
          <!-- Percent Change Display -->
          <small id="percentChangeDisplay" style="font-weight: bold; font-size: 1.5rem; position: absolute; top: 50%; right: 10px; transform: translateY(-50%);"></small>
          <!-- Time Range Selector -->
          <div id="portfolioTimeframeControls">
            <div class="btn-group btn-group-sm" role="group" aria-label="Portfolio Timeframe">
              <button type="button" class="btn btn-outline-secondary" onclick="setPortfolioTimeframe(1)">1h</button>
              <button type="button" class="btn btn-outline-secondary" onclick="setPortfolioTimeframe(3)">3h</button>
              <button type="button" class="btn btn-outline-secondary" onclick="setPortfolioTimeframe(6)">6h</button>
              <button type="button" class="btn btn-outline-secondary" onclick="setPortfolioTimeframe(12)">12h</button>
              <button type="button" class="btn btn-outline-secondary" onclick="setPortfolioTimeframe(24)">24h</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <canvas id="portfolioChart" style="width: 100%; height: 300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Top Positions Card and Size Comparison Chart Card (Unchanged) -->
  <div class="row">
    <!-- Top Positions Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Top Positions</h3>
        </div>
        <div class="card-body">
          {% if top_positions %}
            {% for pos in top_positions %}
              {% set box_class = "text-bg-blue" %}
              {% if pos.alert_state == "alert-low" %}
                {% set box_class = "text-bg-success" %}
              {% elif pos.alert_state == "alert-medium" %}
                {% set box_class = "text-bg-warning" %}
              {% elif pos.alert_state == "alert-high" %}
                {% set box_class = "text-bg-danger" %}
              {% endif %}
              <div class="info-box">
                <span class="info-box-icon {{ box_class }} text-white">
                  <span class="small-percentage">
                    {{ pos.current_travel_percent | round(0, 'floor') | int }}%
                  </span>
                </span>
                <div class="info-box-content">
                  <div class="info-box-asset">
                    <span class="info-box-extra">
                      <img src="{{ url_for('static', filename='images/' ~ pos.asset_type|lower ~ '_logo.png') }}"
                           alt="{{ pos.asset_type }} Logo"
                           onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default_logo.png') }}';">
                      <span>{{ pos.position_type }}</span>
                    </span>
                    <div class="info-box-details">
                      <span>Value: <strong>${{ pos.value }}</strong></span>
                      <span>Size: <strong>{{ pos.size }}</strong></span>
                      <span>Collateral: <strong>${{ pos.collateral }}</strong></span>
                    </div>
                  </div>
                </div>
                <div class="info-box-wallet">
                  <img src="{{ pos.wallet_image or url_for('static', filename='images/landovault.jpg') }}"
                       alt="Wallet Logo"
                       onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/landovault.jpg') }}';">
                </div>
              </div>
            {% endfor %}
          {% else %}
            <!-- Sample data for testing (if no positions found) -->
            <div class="info-box">
              <span class="info-box-icon text-bg-blue text-white">
                <span class="small-percentage">75%</span>
              </span>
              <div class="info-box-content">
                <div class="info-box-asset">
                  <span class="info-box-extra">
                    <img src="https://via.placeholder.com/20" alt="BTC Logo">
                    <span>Long BTC</span>
                  </span>
                  <div class="info-box-details">
                    <span>Value: <strong>$10,000</strong></span>
                    <span>Size: <strong>1.5</strong></span>
                    <span>Collateral: <strong>$5,000</strong></span>
                  </div>
                </div>
              </div>
              <div class="info-box-wallet">
                <img src="https://via.placeholder.com/30" alt="Wallet Logo">
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Size Comparison Chart Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Size Comparison Chart</h3>
        </div>
        <div class="card-body">
          <div id="positions-chart"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Include Chart.js and adapter for time scales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  // Global portfolioData and portfolioChart variable
  const portfolioData = {{ portfolio_data | tojson }};
  let portfolioChart;

  document.addEventListener('DOMContentLoaded', function() {
    if (!portfolioData || portfolioData.length === 0) {
      console.warn("No portfolio data available for chart rendering.");
      return;
    }
    // Build the portfolio performance chart using all portfolioData
    const labels = portfolioData.map(item => item.snapshot_time);
    const data = portfolioData.map(item => item.total_value);
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    portfolioChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total Portfolio Value',
          data: data,
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' }
          },
          y: { beginAtZero: true }
        }
      }
    });
    // Initialize percent change display based on default timeframe (24h)
    setPortfolioTimeframe(24);
  });

  function setPortfolioTimeframe(hours) {
    if (!portfolioData || portfolioData.length === 0) return;
    const currentTime = new Date();
    const cutoff = new Date(currentTime.getTime() - hours * 3600000);
    console.log("Current Time:", currentTime, "Cutoff:", cutoff);
    const filteredData = portfolioData.filter(item => new Date(item.snapshot_time) >= cutoff);
    console.log("Filtered data count:", filteredData.length);
    const newLabels = filteredData.map(item => item.snapshot_time);
    const newData = filteredData.map(item => item.total_value);
    portfolioChart.data.labels = newLabels;
    portfolioChart.data.datasets[0].data = newData;
    portfolioChart.update();

    if (filteredData.length > 0) {
      const firstValue = filteredData[0].total_value;
      const lastValue = filteredData[filteredData.length - 1].total_value;
      const percentChange = ((lastValue - firstValue) / firstValue) * 100;
      const percentElem = document.getElementById("percentChangeDisplay");
      if (percentElem) {
        percentElem.textContent = percentChange.toFixed(2) + "%";
        percentElem.style.color = percentChange >= 0 ? "green" : "red";
      }
    }
  }
</script>

<script>
  // Size Comparison Chart using ApexCharts with dynamic data from API
  window.onload = function() {
    console.log("Window loaded, fetching size composition data");
    if (typeof ApexCharts === 'undefined') {
      console.error("ApexCharts library not loaded!");
      return;
    }
    var chartContainer = document.getElementById("positions-chart");
    if (!chartContainer) {
      console.error("positions-chart container not found");
      return;
    }
    // Fetch the size composition data from the API
    fetch("/api/size_composition")
      .then(response => response.json())
      .then(data => {
         var seriesData = data.series || [0, 0];
         console.log("Fetched size composition data:", seriesData);
         var options = {
           series: seriesData,
           chart: {
             type: 'pie',
             height: 350,
             events: {
               click: function(event, chartContext, config) {
                 var currentType = chartInstance.w.config.chart.type;
                 var newType = currentType === 'pie' ? 'donut' : 'pie';
                 chartInstance.updateOptions({ chart: { type: newType } });
                 console.log("Chart type toggled to:", newType);
               }
             }
           },
           labels: ['Long Positions', 'Short Positions'],
           colors: ['#0d6efd', '#5dcc8e'],
           legend: { position: 'bottom' },
           dataLabels: { enabled: true, style: { fontSize: '1.2rem' } }
         };
         // Create and render the chart instance
         var chartInstance = new ApexCharts(chartContainer, options);
         chartInstance.render()
           .then(function() { console.log("ApexCharts rendered successfully with size composition data"); })
           .catch(function(err) { console.error("ApexCharts render error:", err); });
      })
      .catch(function(err) {
         console.error("Error fetching size composition data:", err);
      });
  };
</script>

<script>
  // Update Button Script for Jupiter button (unchanged)
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.querySelector('.update-button[data-type="{{ update_type | default("jupiter") }}"]');
    if (!container) return;
    const img = container.querySelector('img');
    container.addEventListener("click", function() {
      console.log("Update button clicked.");
      img.classList.add("spin");
      fetch("/positions/update_jupiter?source={{ update_type | default('jupiter') }}", { method: "POST" })
        .then(response => response.json())
        .then(data => {
            console.log("Update response:", data);
            img.classList.remove("spin");
        })
        .catch(err => {
            console.error("Error updating positions:", err);
            img.classList.remove("spin");
        });
    });
  });
</script>

<style>
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .spin { animation: spin 1s linear infinite; }
</style>

<script>
  // Theme Toggle Script remains unchanged
  document.addEventListener('DOMContentLoaded', function() {
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.add(currentTheme + '-mode');
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.checked = currentTheme === 'dark';
    themeToggle.addEventListener('change', function() {
      if (this.checked) {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        localStorage.setItem('theme', 'light');
      }
    });
  });
</script>
{% endblock %}

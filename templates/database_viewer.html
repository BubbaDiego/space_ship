<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Database Viewer - Wallets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- (Optional) AdminLTE CSS if needed -->
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='AdminLTE/dist/css/adminlte.css') }}"> -->

  <!-- Custom CSS overrides loaded after other CSS -->
  <style>
    /* Ensure the background image is fixed, covers entirely, and the cards are opaque */
    body {
      background: url("{{ url_for('static', filename='images/database_wall.jpg') }}") no-repeat center center fixed !important;
      background-size: cover !important;
    }
    .card {
      background-color: #fff !important;
      border: 1px solid #dee2e6 !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important;
      margin-bottom: 1rem !important;
    }
    .card-header {
      background-color: #e7f0fd !important;
      color: #003366 !important;
      padding: 0.5rem 1rem !important;
      cursor: pointer !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    .card-header button.btn-light {
      font-weight: bold !important;
    }
    /* Modal form styling */
    #editFormContainer .form-label {
      font-weight: 600 !important;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="mb-4">Database Viewer - Wallets</h1>
    {# Assume db_data.wallets exists; if not, set a default #}
    {% set wallet_data = db_data.wallets | default({ "columns": [], "rows": [] }) %}
    <div class="card" data-table="wallets" data-columns='{{ wallet_data.columns | tojson | safe }}'>
      <div class="card-header" data-target="#collapse-wallets">
        <button class="btn btn-light" type="button">
          <strong>Wallets</strong>
        </button>
        <button class="btn btn-sm btn-outline-danger deleteTableBtn" title="Delete Table">
          <i class="bi bi-trash"></i>
        </button>
      </div>
      <div id="collapse-wallets" class="collapse show">
        <div class="card-body">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                {% for col in wallet_data.columns %}
                  <th>{{ col }}</th>
                {% endfor %}
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in wallet_data.rows %}
                <tr data-row-json='{{ row | tojson | safe }}'>
                  {% for col in wallet_data.columns %}
                    <td>{{ row[col] }}</td>
                  {% endfor %}
                  <td class="text-center">
                    <button class="btn btn-sm btn-secondary editBtn" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger deleteBtn" title="Delete Row">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="{{ wallet_data.columns|length + 1 }}" class="text-center">No wallets found.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Wallet</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="editFormContainer">
              <!-- Dynamic form fields will be injected here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // For this file, we'll assume wallets is fully editable (edit and delete)
    const fullyEditableTables = ['wallets'];

    document.addEventListener('DOMContentLoaded', function() {
      // Override default collapse behavior using our custom handler
      document.querySelectorAll('.card-header').forEach(function(header) {
        header.addEventListener('click', function(e) {
          // If clicking on an inner button (but not the main toggle button), ignore.
          if (e.target.closest('button') && !e.target.closest('.btn-light')) return;
          const targetSelector = header.getAttribute('data-target');
          const targetElem = document.querySelector(targetSelector);
          if (targetElem) {
            targetElem.classList.toggle('show');
          }
        });
      });

      let currentRow, currentCard, currentColumns;
      const editModal = new bootstrap.Modal(document.getElementById('editModal'), { backdrop: 'static', keyboard: false });
      const editFormContainer = document.getElementById('editFormContainer');

      // Wallet-specific form generator
      function generateWalletEditForm(rowData) {
        // Define the wallet fields (adjust as needed)
        const walletFields = ['name', 'public_address', 'private_address', 'image_path', 'balance'];
        editFormContainer.innerHTML = '';
        walletFields.forEach(function(field) {
          const formGroup = document.createElement('div');
          formGroup.className = 'mb-3';
          const label = document.createElement('label');
          label.className = 'form-label';
          // Convert field to title-case for display
          label.innerText = field.replace('_', ' ').toUpperCase();
          label.setAttribute('for', 'edit-' + field);
          formGroup.appendChild(label);
          const input = document.createElement('input');
          input.className = 'form-control';
          input.id = 'edit-' + field;
          input.name = field;
          input.value = rowData[field] !== null ? rowData[field] : '';
          // Allow editing all fields, even "name" (since delete and edit must work)
          formGroup.appendChild(input);
          editFormContainer.appendChild(formGroup);
        });
      }

      // Edit button click handler
      document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.editBtn');
        if (editBtn) {
          currentRow = editBtn.closest('tr');
          const rowData = JSON.parse(currentRow.getAttribute('data-row-json'));
          currentCard = editBtn.closest('.card');
          currentColumns = JSON.parse(currentCard.getAttribute('data-columns'));
          // For wallets, generate wallet-specific edit form.
          if (currentCard.getAttribute('data-table') === 'wallets') {
            generateWalletEditForm(rowData);
            document.getElementById('editModalLabel').innerText = "Edit Wallet";
          }
          editModal.show();
          e.stopPropagation();
        }
      });

      // Handle edit form submission
      document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const tableName = currentCard.getAttribute('data-table');
        let updatedData = {};
        // For wallets, use the walletFields array
        const fields = (tableName === 'wallets') ? ['name', 'public_address', 'private_address', 'image_path', 'balance'] : currentColumns;
        fields.forEach(function(field) {
          const input = document.getElementById('edit-' + field);
          if (input) {
            updatedData[field] = input.value;
          }
        });
        // Update row display (update cells for wallet table)
        const cells = currentRow.getElementsByTagName('td');
        fields.forEach(function(field, index) {
          if (cells[index]) {
            cells[index].innerText = updatedData[field];
          }
        });
        currentRow.setAttribute('data-row-json', JSON.stringify(updatedData));
        editModal.hide();

        // Send AJAX update for wallets
        if (fullyEditableTables.includes(tableName)) {
          const pkField = 'name'; // use "name" as primary key for wallets
          const pkValue = updatedData[pkField];
          fetch('/api/update_row', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              table: tableName,
              pk_field: pkField,
              pk_value: pkValue,
              row: updatedData
            })
          })
          .then(response => {
            if (!response.ok) throw new Error('Failed to update row.');
            return response.json();
          })
          .then(data => console.log('Row updated successfully:', data))
          .catch(error => {
            alert('Error updating row: ' + error.message);
            console.error(error);
          });
        }
      });

      // Delete row handler (for wallets)
      document.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.deleteBtn');
        if (deleteBtn) {
          const row = deleteBtn.closest('tr');
          const card = deleteBtn.closest('.card');
          const tableName = card.getAttribute('data-table');
          if (confirm('Are you sure you want to delete this row?')) {
            const rowData = JSON.parse(row.getAttribute('data-row-json'));
            const pkField = 'name'; // primary key for wallets
            const pkValue = rowData[pkField];
            if (fullyEditableTables.includes(tableName)) {
              fetch('/api/delete_row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  table: tableName,
                  pk_field: pkField,
                  pk_value: pkValue
                })
              })
              .then(response => {
                if (!response.ok) throw new Error('Failed to delete row.');
                return response.json();
              })
              .then(data => {
                console.log('Row deleted successfully:', data);
                row.remove();
              })
              .catch(error => {
                alert('Error deleting row: ' + error.message);
                console.error(error);
              });
            } else {
              row.remove();
            }
          }
        }
      });

      // Delete table handler
      document.addEventListener('click', function(e) {
        const deleteTableBtn = e.target.closest('.deleteTableBtn');
        if (deleteTableBtn) {
          const card = deleteTableBtn.closest('.card');
          if (confirm('Are you sure you want to delete this entire table?')) {
            card.remove();
          }
        }
      });
    });
  </script>
</body>
</html>
